<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LibreTV - 免费在线视频搜索与观看平台</title>
    <meta name="description" content="LibreTV是一个免费的在线视频搜索平台，无广告、安全，提供来自多个视频源的内容搜索与观看服务，无需注册即可使用。">
    <meta name="keywords" content="在线视频,免费视频,视频搜索,电影,电视剧,LibreTV">
    <meta name="author" content="LibreTV Team">
    <meta name="robots" content="index, follow">
    <meta name="referrer" content="no-referrer" />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://libretv.is-an.org/">
    <meta property="og:title" content="LibreTV - 免费在线视频搜索与观看平台">
    <meta property="og:description" content="搜索并观看来自多个视频源的内容，支持多种设备，无需注册即可使用。">
    <meta property="og:image" content="https://images.icon-icons.com/38/PNG/512/retrotv_5520.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://libretv.is-an.org/">
    <meta property="twitter:title" content="LibreTV - 免费在线视频搜索与观看平台">
    <meta property="twitter:description" content="搜索并观看来自多个视频源的内容，支持多种设备，无需注册即可使用。">
    <meta property="twitter:image" content="https://images.icon-icons.com/38/PNG/512/retrotv_5520.png">

    <!-- Favicon -->
    <link rel="icon" href="https://images.icon-icons.com/38/PNG/512/retrotv_5520.png">
    <link rel="apple-touch-icon" href="https://images.icon-icons.com/38/PNG/512/retrotv_5520.png">

    <!-- Canonical URL -->
    <link rel="canonical" href="https://libretv.is-an.org/">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        /* Add styles for active tab */
        .category-tab.active {
            background-color: #ff3c78; /* Use accent color */
            color: white;
            border-color: #ff3c78;
            font-weight: 600;
        }
        .category-tab:not(.active) {
             background-color: rgba(255, 255, 255, 0.05); /* Slightly visible inactive tabs */
             border: 1px solid rgba(255, 255, 255, 0.1);
             color: #a0aec0; /* Lighter gray text for inactive */
        }
        .category-tab:not(.active):hover {
             background-color: rgba(255, 255, 255, 0.1);
             border-color: rgba(255, 255, 255, 0.2);
             color: #cbd5e0; /* Slightly lighter gray on hover */
        }
        /* Ensure enough space for the fixed buttons */
        body {
            padding-top: 4.5rem; /* Adjust if necessary */
        }
        /* Center history panel title */
        #historyPanel h3 {
             text-align: center;
             width: 100%;
        }
         /* Style for the refresh button */
        #refreshCategoryBtn {
            background-image: linear-gradient(to right, var(--primary-color), var(--accent-color));
            transition: all 0.3s ease;
        }
        #refreshCategoryBtn:hover:not(:disabled) { /* Add :not(:disabled) */
            opacity: 0.9;
            box-shadow: 0 0 10px rgba(0, 204, 255, 0.5);
        }
        /* Style for disabled refresh button */
         #refreshCategoryBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-image: none;
            background-color: #4a5568; /* Gray background when disabled */
         }
         /* Ensure page takes full height */
        html, body {
             height: 100%;
         }
         /* Main container takes remaining height */
         .main-container {
             display: flex;
             flex-direction: column;
             min-height: calc(100vh - 4.5rem); /* Subtract padding-top */
         }
         .content-wrapper {
             flex-grow: 1; /* Allows content to push footer down */
         }
    </style>
</head>
<body class="page-bg text-white">
    <!-- Top Left History Button -->
    <div class="fixed top-4 left-4 z-50">
        <button onclick="toggleHistory(event)" class="bg-[#222] hover:bg-[#333] border border-[#333] hover:border-white rounded-lg px-4 py-2 transition-colors" aria-label="观看历史">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
        </button>
    </div>

    <!-- Top Right Settings Button -->
    <div class="fixed top-4 right-4 z-50">
        <button onclick="toggleSettings(event)" class="bg-[#222] hover:bg-[#333] border border-[#333] hover:border-white rounded-lg px-4 py-2 transition-colors" aria-label="打开设置">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
             </svg>
        </button>
    </div>

    <!-- History Panel -->
    <div id="historyPanel" class="history-panel fixed left-0 top-0 h-full bg-[#111] border-r border-[#333] p-6 z-40 transform -translate-x-full transition-transform duration-300 overflow-y-auto">
        <div class="flex justify-between items-center mb-6 sticky top-0 bg-[#111] py-2">
            <button onclick="toggleHistory()" class="text-gray-400 hover:text-white" aria-label="关闭历史">×</button>
            <h3 class="text-xl font-bold gradient-text">观看历史</h3>
            <div class="w-6"></div> <!-- Placeholder for centering -->
        </div>
        <div id="historyList" class="pb-4">
             <div class="text-center text-gray-500 py-8">暂无观看记录</div>
        </div>
        <div class="mt-auto text-center sticky bottom-0 pb-2 pt-2 bg-[#111]">
             <button onclick="clearViewingHistory()" class="px-4 py-2 w-full bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 hover:from-indigo-600 hover:via-purple-600 hover:to-pink-600 text-white rounded-lg text-sm transition-all duration-300 shadow-md hover:shadow-lg">
                 清空历史记录
             </button>
         </div>
    </div>

    <!-- Settings Panel -->
    <div id="settingsPanel" class="settings-panel fixed right-0 top-0 h-full w-80 bg-[#111] border-l border-[#333] p-6 z-40 overflow-y-auto">
         {/* ... settings panel content ... */}
    </div>

    <div class="container mx-auto px-4 pt-8 pb-4 flex flex-col main-container"> {/* Added pt-8 and pb-4, main-container */}
        <div class="content-wrapper"> {/* Added content wrapper */}
            <!-- Logo and Title -->
            <header class="text-center mb-4"> {/* Reduced bottom margin */}
                 <div class="flex justify-center items-center mb-2"> {/* Reduced bottom margin */}
                     <svg class="w-10 h-10 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                     </svg>
                     <h1 class="text-5xl font-bold gradient-text">LibreTV</h1>
                 </div>
                 <p class="text-gray-400 mb-6">自由观影，畅享精彩</p> {/* Reduced bottom margin */}
            </header>

            <!-- Search Area -->
            <div id="searchArea" class="flex flex-col items-center justify-start mb-8"> {/* Removed flex-1 */}
                 <h2 class="text-3xl font-bold gradient-text mb-6">视频搜索</h2> {/* Reduced bottom margin */}
                 <div class="w-full max-w-2xl">
                     <div class="flex">
                         <input type="text"
                                id="searchInput"
                                class="w-full bg-[#111] border border-[#333] text-white px-6 py-4 rounded-l-lg focus:outline-none focus:border-white transition-colors"
                                placeholder="搜索你喜欢的视频..."
                                aria-label="视频搜索框">
                         <button onclick="search()"
                                 class="px-8 py-4 bg-white text-black font-medium rounded-r-lg hover:bg-gray-200 transition-colors"
                                 aria-label="搜索按钮">
                             搜索
                         </button>
                     </div>
                     <div id="recentSearches" class="mt-4 flex flex-wrap gap-2" aria-label="最近搜索记录">
                         {/* Recent searches */}
                     </div>
                     {/* Clear history button removed from here, maybe add to history panel? */}
                 </div>
             </div>

             <!-- Category Tabs and Refresh Button -->
             <div id="category-section" class="w-full max-w-5xl mx-auto mb-6 px-2"> {/* Increased max-width slightly */}
                 <div class="flex flex-col sm:flex-row items-center justify-between gap-4"> {/* Stack vertically on small screens */}
                     <div id="categoryTabs" class="flex flex-wrap justify-center gap-2">
                         {/* Tabs will be generated here */}
                     </div>
                     <button id="refreshCategoryBtn" class="px-5 py-1.5 text-sm rounded-lg text-white font-semibold shadow-md flex-shrink-0"> {/* Increased padding */}
                         换一批
                     </button>
                 </div>
             </div>

             <!-- Douban Results Area -->
             <div id="douban-results" class="w-full max-w-6xl mx-auto grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 mb-8"> {/* Added bottom margin */}
                 <div class="col-span-full text-center text-gray-400 py-10" id="loading">正在加载数据…</div>
             </div>

             <!-- Search Results Area (Hidden initially) -->
             <div id="resultsArea" class="w-full hidden">
                 <div id="results" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
                     {/* Search results */}
                 </div>
             </div>
        </div> {/* End content-wrapper */}

        <!-- Footer -->
        <footer class="footer py-6 border-t border-[#333] bg-[#0a0a0a]"> {/* Removed mt-8, relies on flex layout */}
             {/* ... footer content ... */}
        </footer>
    </div> {/* End main-container */}


    <!-- Modals -->
    {/* ... modal divs ... */}

    <!-- Toast & Loading -->
    {/* ... toast and loading divs ... */}

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/js-sha256@0.9.0/build/sha256.min.js"></script>
    <script> window._jsSha256 = window.sha256; </script>
    <script src="js/config.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/api.js"></script>
    <script src="js/password.js"></script>
    <script src="js/app.js"></script>
    <script> window.__ENV__ = window.__ENV__ || {}; window.__ENV__.PASSWORD = "{{PASSWORD}}"; </script>
    <script> /* ... disclaimer logic ... */ </script>

    <!-- Updated Douban/Category Script -->
    <script>
    // --- Category and Douban Logic ---

    const categories = [
        { name: '热门', tag: '热门' },
        { name: '国产剧', tag: '国产剧' },
        { name: '美剧', tag: '美剧' },
        { name: '英剧', tag: '英剧' },
        { name: '日本动画', tag: '日本动画' },
        { name: '纪录片', tag: '纪录片' },
        { name: '综艺', tag: '综艺' }
    ];
    let currentCategoryTag = '国产剧'; // Default active category
    let currentPageStart = 0;
    const showsPerPage = 30; // Douban API limit

    const categoryTabsContainer = document.getElementById('categoryTabs');
    const refreshButton = document.getElementById('refreshCategoryBtn');
    const doubanContainer = document.getElementById("douban-results");
    const loadingIndicator = document.getElementById("loading");

    // Helper logDebug function (if not globally available)
    if (typeof logDebug === 'undefined') {
        function logDebug(message) { console.log("[Debug]", message); }
    }

    // Function to create category tabs
    function createCategoryTabs() {
        if (!categoryTabsContainer) return;
        categoryTabsContainer.innerHTML = ''; // Clear existing tabs
        categories.forEach(category => {
            const button = document.createElement('button');
            button.textContent = category.name;
            button.className = 'category-tab px-3 py-1 text-xs sm:text-sm rounded border transition whitespace-nowrap'; // Added whitespace-nowrap
            button.dataset.tag = category.tag;

            if (category.tag === currentCategoryTag) {
                button.classList.add('active'); // Mark default active
            }

            button.addEventListener('click', () => {
                document.querySelectorAll('.category-tab').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                currentCategoryTag = category.tag;
                currentPageStart = 0; // Reset page when changing category
                fetchDoubanTV(currentCategoryTag, currentPageStart);
            });
            categoryTabsContainer.appendChild(button);
        });
    }

    // Function to fetch Douban data (modified)
    async function fetchDoubanTV(tag = '国产剧', pageStart = 0) {
        if (!doubanContainer || !loadingIndicator || !refreshButton) return;

        // Show loading state
        doubanContainer.innerHTML = ''; // Clear previous results
        loadingIndicator.textContent = `正在加载 "${tag}" 数据...`;
        loadingIndicator.style.display = 'block';
        doubanContainer.appendChild(loadingIndicator);
        refreshButton.disabled = true; // Disable refresh during load

        const proxy = "https://api.allorigins.win/raw?url="; // Use your preferred CORS proxy if needed
        const target = `https://movie.douban.com/j/search_subjects?type=tv&tag=${encodeURIComponent(tag)}&sort=recommend&page_limit=${showsPerPage}&page_start=${pageStart}`;

        logDebug(`Fetching Douban: ${tag}, Start: ${pageStart}`);

        try {
            const response = await fetch(proxy + encodeURIComponent(target));
            if (!response.ok) {
                 throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();

            loadingIndicator.style.display = 'none'; // Hide loading

            if (!data.subjects || data.subjects.length === 0) {
                doubanContainer.innerHTML = `<div class="col-span-full text-center text-gray-400 py-10">"${tag}" 分类下没有更多内容了。</div>`;
                // Keep refresh button disabled as there are no more pages
                return;
            }

            // Results found, enable refresh button
            refreshButton.disabled = false;

            const fragment = document.createDocumentFragment();
            data.subjects.forEach(tv => {
                const item = document.createElement("div");
                // Using Solution 1: object-contain, aspect-ratio, no background on container
                item.className = "hover:scale-105 transition transform duration-200 ease-in-out flex flex-col items-center text-center"; // Removed bg and padding from outer div
                item.innerHTML = `
                    <button
                      class="relative w-full flex justify-center group active:scale-95 transition transform duration-150 ease-in-out mb-1"
                      onclick="fillAndSearch('${tv.title.replace(/'/g, "\\'")}')" /* Escape single quotes in title */
                    >
                    <!-- Container sets aspect ratio -->
                    <div class="relative w-full aspect-[2/3] overflow-hidden rounded-md">
                      <img
                        src="${tv.cover}"
                        alt="${tv.title}"
                        class="w-full h-full object-contain group-hover:opacity-90 transition duration-300 ease-in-out" /* Removed rounded-md here */
                        loading="lazy"
                        onerror="this.style.display='none'; this.parentElement.innerHTML+='<div class=\'text-xs text-gray-500 p-2\'>图片加载失败</div>'"
                      />
                      <!-- Rating positioned over the image container -->
                      <div class="absolute bottom-1 left-1 right-1 bg-black/70 text-white text-xs font-semibold px-1.5 py-0.5 rounded text-center pointer-events-none">
                        评分: ${tv.rate || "暂无"}
                      </div>
                    </div>
                    </button>
                    <a
                      href="${tv.url}"
                      target="_blank"
                      class="w-full block text-xs font-semibold truncate hover:text-blue-400 px-1" /* Adjusted padding/margin */
                      title="${tv.title}"
                    >
                      ${tv.title}
                    </a>
                `;
                fragment.appendChild(item);
            });

            doubanContainer.innerHTML = ''; // Clear loading message
            doubanContainer.appendChild(fragment);

            // Update current page for next refresh cycle
            currentPageStart = pageStart;

        } catch (err) {
            loadingIndicator.style.display = 'none';
            doubanContainer.innerHTML = `<div class="col-span-full text-red-400 text-center py-10">❌ 获取 "${tag}" 数据失败，请稍后重试或检查网络。</div>`;
            console.error(`豆瓣 API 请求失败 (${tag}, ${pageStart}):`, err);
            // Keep refresh button disabled on error
        }
    }

    // Function to fill search input and trigger search
    function fillAndSearch(title) {
          const input = document.getElementById('searchInput');
          input.value = title;
          window.scrollTo({ top: 0, behavior: 'smooth' });
          input.focus();
          if (typeof search === 'function') {
               search();
          } else {
               console.error("Search function not found.");
          }
          // Hide Douban results after clicking to show search results
          const doubanContainer = document.getElementById("douban-results");
          if (doubanContainer) doubanContainer.style.display = "none";
          // Show search results area if it was hidden
          const resultsArea = document.getElementById('resultsArea');
          if (resultsArea) resultsArea.classList.remove('hidden');

    }


    // --- Initialization ---
    document.addEventListener("DOMContentLoaded", () => {
        createCategoryTabs(); // Create tabs
        fetchDoubanTV(currentCategoryTag, currentPageStart); // Fetch initial data

        // Add event listener for the refresh button
        if (refreshButton) {
            refreshButton.addEventListener('click', () => {
                if (!refreshButton.disabled) { // Check if button is not disabled
                    const nextPageStart = currentPageStart + showsPerPage;
                    fetchDoubanTV(currentCategoryTag, nextPageStart);
                }
            });
        } else {
             console.error("Refresh button not found.");
        }

        // Ensure search results are hidden initially if Douban results load
        const resultsArea = document.getElementById('resultsArea');
        if (resultsArea) resultsArea.classList.add('hidden');

    });

    </script>
</body>
</html>
